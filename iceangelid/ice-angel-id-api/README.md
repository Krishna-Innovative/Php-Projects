# iCE Angel - ID API

## Installation

After installing prerequisites, run

```
	composer install 
```

## Deployment


Update configurations files: ```.env.production.php``` and ```.env.staging.php ``` and upload to server:

	cap staging deploy:ops:config:upload_env

Upload updated vendor folders

	cap staging deploy:ops:composer:upload_vendor
	
Deploy via capistrano (with capistrano-file-permissions)

	cap staging deploy

Set the configuration file ```.env.php``` for your local environment


## Add and activate users via command line

Bulk load users with CSV files, example files in  `downloads` using this command:


```

php artisan iceangel:add-user ~/Desktop/users.csv

```

## Add coupons en masse to db and stripe account

Read coupons from plain text file (assign to partner id, e.g., 88):


```

php artisan iceangel:generate-coupons 88 /home/cesar/Desktop/tcoupon.txt

```

Also, accepts arguments for a single insurance record


## Send Partner Subscribers Emails

```

php artisan iceangel:send-partner-quota-email 50000 partner1@iceangelid.com partner2@iceangelid.com

```

Sends an email up to 2 inboxes (plus admin), with quota argument, last week and total subscribers 
TODO: refactor to use partner_promo table and prefix argument (instead of quota)



## API Authentication

Some APIs are reserved for partner accounts, and request using api keys.

Example request:

```

curl --header "X-Authorization: AUTHKEY" --header "Accept-Language: en" https://api.iceangelid.com/api-endpoint

```

Keys can be generated by artisan console, e.g.:

```
php artisan iceangel:partner-key 88

```

where argument must be a valid `user-id`

To generate a new key without user:

`php artisan api-key:generate`


## Prerequisites 

###ZeroMQ

1- Install ZeroMQ with PHP binding...

Go to ```http://zeromq.org/area:download``` and choose a package according your OS, e.g. 4.0.4

```
tar -xvf zeromq-4.0.4.tar
cd zeromq-4.0.4
./configure
make
sudo make install
```

2- Install zmq php binding...

```
git clone git://github.com/mkoppanen/php-zmq.git
cd php-zmq
phpize && ./configure
make
sudo make install
```

3- Setup php.ini

```
sudo cp /private/etc/php.ini.default /private/etc/php.ini

# add to php.ini
extension=zmq.so

sudo apachectl restart

```

- https://pear.php.net/manual/en/installation.getting.php
- http://alexandervn.nl/2012/05/03/install-zeromq-php-ubuntu/


4- Install binding (important!)

```
sudo pecl install zmq-beta
```

Check installed php version and update php.ini, e.g.,

```
sudo nano /usr/local/php5-5.6.16-20151226-184008/lib/php.ini

#add 
extension=zmq.so
```

http://zeromq.org/bindings%3aphp

###mcrypt

 # option 1: migrate to php5.6 with mcrypt included



```
curl -s http://php-osx.liip.ch/install.sh | bash -s 5.6

# add to ~/.profile
export PATH=/usr/local/php5/bin:$PATH

```

```

# add to php.ini
extension=mcrypt.so
sudo apachectl restart

```

###fileinfo

usually included